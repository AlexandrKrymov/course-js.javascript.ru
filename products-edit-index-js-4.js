(window.webpackJsonp=window.webpackJsonp||[]).push([[4],{11:function(e,t,s){"use strict";function n(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}s.d(t,"a",(function(){return i}));class i{constructor({items:e}={}){n(this,"onPointerDown",e=>{const t=e.target.closest(".sortable-list__item");if(!t)return;e.preventDefault();const s=e.target.closest("[data-grab-handle]"),n=e.target.closest("[data-delete-handle]");s?this.dragstart(t,e):n&&t.remove()}),n(this,"onPointerUp",e=>{e.preventDefault(),this.dragend()}),n(this,"onPointerMove",e=>{e.preventDefault(),this.setStyles(this.dragged,{left:e.x-this.shiftX+"px",top:e.y-this.shiftY+"px"}),this.dragged.style.visibility="hidden";const t=document.elementFromPoint(e.x,e.y);if(this.dragged.style.visibility="",!t)return void this.dragend();const s=t.closest(".sortable-list__item");if(!s||s===this.currentDroppable)return void(this.currentDroppable=null);const n=s.getBoundingClientRect().top,i=this.getMoveDirection(this.pageY,e.pageY);if(this.pageY=e.pageY,e.pageY>n){const e="down"===i?s.nextSibling:s;this.insertPlaceholder(e)}this.currentDroppable=s}),this.elements=e,this.render(),this.addEventListeners()}render(){const e=document.createElement("ul");e.classList.add("sortable-list");const t=this.elements.map(e=>this.getListItem(e));e.append(...t),this.placeholder=this.getPlaceholder(),this.element=e}getListItem(e){const t="object"==typeof e?e:this.toHTML(e);return t.classList.add("sortable-list__item"),t}getPlaceholder(){const e=document.createElement("div");return e.classList.add("sortable-list__placeholder"),e}addEventListeners(){this.element.addEventListener("pointerdown",this.onPointerDown)}removeEventListeners(){this.element.removeEventListener("pointerdown",this.onPointerDown)}setStyles(e,t){for(const s in t)e.style[s]=t[s]}dragstart(e,t){this.dragged=e,this.element.addEventListener("pointerup",this.onPointerUp);const s=this.dragged.getBoundingClientRect();this.shiftX=t.clientX-s.left,this.shiftY=t.clientY-s.top,this.draggedHeight=this.dragged.clientHeight,this.draggedWidth=this.dragged.clientWidth,this.setStyles(this.dragged,{width:this.draggedWidth+"px",left:t.x-this.shiftX+"px",top:t.y-this.shiftY+"px"}),this.setStyles(this.placeholder,{height:this.draggedHeight+"px"}),this.insertPlaceholder(this.dragged),this.dragged.classList.add("sortable-list__item_dragging"),this.element.addEventListener("pointermove",this.onPointerMove)}dragend(){this.element.insertBefore(this.dragged,this.placeholder),this.placeholder.remove(),this.setStyles(this.dragged,{width:"",left:"",top:""}),this.dragged.classList.remove("sortable-list__item_dragging"),this.dragged=null,this.element.removeEventListener("pointermove",this.onPointerMove),this.element.removeEventListener("pointerup",this.onPointerUp),this.element.dispatchEvent(new CustomEvent("dragend"))}getMoveDirection(e,t){return e<t?"down":e>t?"up":void 0}insertPlaceholder(e){this.element.insertBefore(this.placeholder,e)}toHTML(e){const t=document.createElement("div");return t.innerHTML=e,t.firstElementChild}remove(){this.element&&this.element.remove(),this.element=null,this.removeEventListeners()}destroy(){this.remove()}}},12:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));class n{constructor(e="",{duration:t=1e3,type:s="success"}={}){this.message=e,this.duration=t,this.type=s,this.render()}get template(){return`\n      <div class="notification notification_${this.type} show">\n        <div class="notification__content"> ${this.message}</div>\n      </div>\n    `}setTimer(){setTimeout(()=>{this.destroy()},this.duration)}render(){const e=document.createElement("div");e.innerHTML=this.template,this.element=e.firstElementChild}show(e=document.body){n.currentNotification&&n.currentNotification.destroy(),e.append(this.element),clearTimeout(n.timer),n.timer=this.setTimer(),n.currentNotification=this}remove(){this.element&&this.element.remove(),this.element=null}destroy(){this.remove(),n.currentNotification=null}}},6:function(e,t,s){"use strict";s.r(t),s.d(t,"default",(function(){return c}));var n=s(11),i=e=>e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;");function r(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class o{constructor(e){r(this,"onSubmit",e=>{e.preventDefault(),this.save()}),r(this,"addImage",e=>{e.preventDefault();const t=document.createElement("input");t.type="file",t.accept="image/*",t.hidden=!0,t.addEventListener("change",this.uploadImage),this.subElements.imageListContainer.append(t),t.click()}),r(this,"uploadImage",async e=>{const t=e.target.files[0],s=new FormData;s.set("image",t),this.subElements.productForm.uploadImage.classList.add("is-loading"),this.subElements.productForm.uploadImage.disabled=!0;try{const e=await fetch("https://api.imgur.com/3/image",{method:"POST",headers:{Authorization:"Client-ID 28aaa2e823b03b1"},body:s}),t=await e.json();this.images.push({source:t.data.name,url:t.data.link}),this.renderImagesList()}catch(e){console.error(e)}finally{this.subElements.productForm.uploadImage.classList.remove("is-loading"),this.subElements.productForm.uploadImage.disabled=!1}}),this.productId=e,this.images=[],this.productsUrl=new URL("api/rest/products  ","https://course-js.javascript.ru/"),this.categoriesUrl=new URL("api/rest/categories  ","https://course-js.javascript.ru/")}async render(){const e=[this.loadCategories()];this.productId&&e.push(this.loadProductData());const[t,s={}]=await Promise.all(e);return s.images&&(this.images=s.images),this.element?this.element.replaceWith(this.toHTML(this.getTemplate(s,t))):this.element=this.toHTML(this.getTemplate(s,t)),this.subElements=this.getSubElements(this.element),this.renderImagesList(),this.addEventListeners(),this.element}renderImagesList(){const e=this.getImagesList(this.images);this.imagesList?this.imagesList.replaceWith(e):this.subElements.imageListContainer.append(e),this.imagesList=e}async loadProductData(){this.productsUrl.searchParams.set("id",this.productId);const e=await fetch(this.productsUrl.toString()),t=await e.json();return this.productData=t[0],t[0]}async loadCategories(){this.categoriesUrl.searchParams.set("_sort","weight"),this.categoriesUrl.searchParams.set("_refs","subcategory");const e=await fetch(this.categoriesUrl.toString());return await e.json()}async save(){const e=this.productsUrl.toString(),t=this.productId?"PATCH":"PUT",s=this.getFormData(),n=this.productId?"product-updated":"product-saved";try{const i=await fetch(e,{method:t,headers:{"Content-Type":"application/json"},body:s}),r=await i.json();return document.dispatchEvent(new CustomEvent(n,{detail:{product:r}})),r}catch(e){console.error("Save product",e)}}getFormData(){const e=this.subElements.productForm,t=new FormData(e),s={title:t.get("title"),description:t.get("description"),subcategory:t.get("subcategory"),price:parseInt(t.get("price")),discount:parseInt(t.get("discount")),quantity:parseInt(t.get("quantity")),status:parseInt(t.get("status")),images:this.getImagesData(t)};return this.productData&&this.productData.id&&(s.id=this.productData.id),JSON.stringify(s)}getImagesData(e){const t=e.getAll("source"),s=e.getAll("url");return t.map((e,t)=>({url:s[t],source:e}))}getTemplate({title:e="",description:t="",price:s=0,discount:n=0,quantity:r=0,status:o="",subcategory:a=""}={},l){return`\n      <div class="product-form">\n        <form data-element="productForm" class="form-grid">\n          <div class="form-group form-group__half_left">\n            <fieldset>\n              <label class="form-label">Название товара</label>\n              <input required="" value="${i(e)}" id="title" type="text" name="title" class="form-control" placeholder="Название товара">\n            </fieldset>\n          </div>\n          <div class="form-group form-group__wide">\n            <label class="form-label">Описание</label>\n            <textarea required="" class="form-control" id="description" name="description" data-element="productDescription" placeholder="Описание товара">${i(t)}</textarea>\n          </div>\n          <div class="form-group form-group__wide" data-element="sortable-list-container">\n            <label class="form-label">Фото</label>\n            <div data-element="imageListContainer"></div>\n            <button data-element="imageUploadBtn" type="button" name="uploadImage" class="button-primary-outline"><span>Загрузить</span></button>\n          </div>\n          <div class="form-group form-group__half_left">\n            <label class="form-label">Категория</label>\n            ${this.getCategoriesSelectTemplate(l,a)}\n          </div>\n          <div class="form-group form-group__half_left form-group__two-col">\n            <fieldset>\n              <label class="form-label">Цена ($)</label>\n              <input required="" value="${s}" id="price" type="number" name="price" class="form-control" placeholder="100">\n            </fieldset>\n            <fieldset>\n              <label class="form-label">Скидка ($)</label>\n              <input required="" value="${n}" id="discount" type="number" name="discount" class="form-control" placeholder="0">\n            </fieldset>\n          </div>\n          <div class="form-group form-group__part-half">\n            <label class="form-label">Количество</label>\n            <input required="" value="${r}" id="quantity" type="number" class="form-control" name="quantity" placeholder="1">\n          </div>\n          <div class="form-group form-group__part-half">\n            <label class="form-label">Статус</label>\n            <select class="form-control" id="status" name="status">\n              <option ${o?"selected":""} value="1">Активен</option>\n              <option ${o?"":"selected"} value="0">Неактивен</option>\n            </select>\n          </div>\n          <div class="form-buttons">\n            <button type="submit" name="save" class="button-primary-outline">\n              Сохранить товар\n            </button>\n          </div>\n        </form>\n      </div>\n    `}getCategoriesSelectTemplate(e=[],t=""){return`\n      <select class="form-control" id="subcategory" name="subcategory" id="subcategory">\n        ${e.map(e=>e.subcategories.map(s=>{const n=i(`${e.title} > ${s.title}`),r=s.id===t;return`<option value="${s.id}" ${r?"selected":""}>${n}</option>`}).join("")).join("")}\n      </select>\n    `}getImagesList(e=[]){const t=e.map(e=>`\n        <li class="products-edit__imagelist-item" style="">\n          <input type="hidden" name="url" value="${i(e.url)}">\n          <input type="hidden" name="source" value="${i(e.source)}">\n          <span>\n            <img src="/icons/icon-grab.svg" data-grab-handle alt="grab">\n            <img class="sortable-table__cell-img" alt="${i(e.source)}" src="${i(e.url)}">\n            <span>${i(e.source)}</span>\n          </span>\n          <button type="button">\n            <img src="/icons/icon-trash.svg" data-delete-handle alt="delete">\n          </button>\n        </li>\n      `);return this.createSortableList(t)}createSortableList(e){return new n.a({items:e}).element}getSubElements(e){const t={};return[...e.querySelectorAll("[data-element]")].forEach(e=>{t[e.dataset.element]=e}),t}addEventListeners(){this.subElements.productForm.addEventListener("submit",this.onSubmit),this.subElements.imageUploadBtn.addEventListener("pointerup",this.addImage)}removeEventListeners(){this.subElements.productForm.removeEventListener("submit",this.onSubmit),this.subElements.imageUploadBtn.removeEventListener("pointerup",this.addImage)}remove(){this.element&&this.element.remove(),this.element=null}destroy(){this.remove(),this.removeEventListeners()}toHTML(e){const t=document.createElement("div");return t.innerHTML=e,t.firstElementChild}}var a=s(12);function l(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}const d=s(0).a.instance();class c{constructor(){l(this,"conponents",void 0),l(this,"productId",this.getProductId()),l(this,"onProductUpdate",()=>{this.notyShow("Товар сохранен")}),l(this,"onProductSave",e=>{this.notyShow("Товар создан"),d.navigate("/products/"+e.detail.product.id)})}getProductId(){const e=window.location.href.split("/");return"add"!==e[e.length-1]?e[e.length-1]:null}async render(){return await this.initComponents(),this.element=this.toHTML(this.getTemplate()),this.renderComponents(),this.subElements=this.getSubElements(this.element),this.addEventListeners(),this.element}getTemplate(){return'\n      <div class="products-edit">\n        <div class="content__top-panel">\n          <h1 class="page-title"><a href="/products" class="link">Товары</a> / Добавить</h1>\n        </div>\n        <div class="content-box">\n          <div data-productForm></div>\n        </div>\n      </div>\n    '}async initComponents(){const e=new o(this.productId);await e.render(),this.components={productForm:e}}renderComponents(){for(const e of Object.entries(this.components))this.element.querySelector(`[data-${e[0]}]`).replaceWith(e[1].element)}getSubElements(e){const t={};return[...e.querySelectorAll("[data-element]")].forEach(e=>{t[e.dataset.element]=e}),t}notyShow(e="",t="success",s=2e3){new a.a(e,{duration:s,type:t}).show()}addEventListeners(){document.addEventListener("product-updated",this.onProductUpdate),document.addEventListener("product-saved",this.onProductSave)}removeEventListeners(){document.removeEventListener("product-updated",this.onProductUpdate),document.removeEventListener("product-saved",this.onProductSave)}remove(){this.element&&this.element.remove(),this.element=null}destroy(){this.remove(),this.removeEventListeners();for(const e of Object.values(this.components))e.destroy()}toHTML(e){const t=document.createElement("div");return t.innerHTML=e,t.firstElementChild}}}}]);
//# sourceMappingURL=products-edit-index-js-4.js.map