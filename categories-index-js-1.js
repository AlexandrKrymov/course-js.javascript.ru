(window.webpackJsonp=window.webpackJsonp||[]).push([[1],{11:function(e,t,s){"use strict";function i(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}s.d(t,"a",(function(){return n}));class n{constructor({items:e}={}){i(this,"onPointerDown",e=>{const t=e.target.closest(".sortable-list__item");if(!t)return;e.preventDefault();const s=e.target.closest("[data-grab-handle]"),i=e.target.closest("[data-delete-handle]");s?this.dragstart(t,e):i&&t.remove()}),i(this,"onPointerUp",e=>{e.preventDefault(),this.dragend()}),i(this,"onPointerMove",e=>{e.preventDefault(),this.setStyles(this.dragged,{left:e.x-this.shiftX+"px",top:e.y-this.shiftY+"px"}),this.dragged.style.visibility="hidden";const t=document.elementFromPoint(e.x,e.y);if(this.dragged.style.visibility="",!t)return void this.dragend();const s=t.closest(".sortable-list__item");if(!s||s===this.currentDroppable)return void(this.currentDroppable=null);const i=s.getBoundingClientRect().top,n=this.getMoveDirection(this.pageY,e.pageY);if(this.pageY=e.pageY,e.pageY>i){const e="down"===n?s.nextSibling:s;this.insertPlaceholder(e)}this.currentDroppable=s}),this.elements=e,this.render(),this.addEventListeners()}render(){const e=document.createElement("ul");e.classList.add("sortable-list");const t=this.elements.map(e=>this.getListItem(e));e.append(...t),this.placeholder=this.getPlaceholder(),this.element=e}getListItem(e){const t="object"==typeof e?e:this.toHTML(e);return t.classList.add("sortable-list__item"),t}getPlaceholder(){const e=document.createElement("div");return e.classList.add("sortable-list__placeholder"),e}addEventListeners(){this.element.addEventListener("pointerdown",this.onPointerDown)}removeEventListeners(){this.element.removeEventListener("pointerdown",this.onPointerDown)}setStyles(e,t){for(const s in t)e.style[s]=t[s]}dragstart(e,t){this.dragged=e,this.element.addEventListener("pointerup",this.onPointerUp);const s=this.dragged.getBoundingClientRect();this.shiftX=t.clientX-s.left,this.shiftY=t.clientY-s.top,this.draggedHeight=this.dragged.clientHeight,this.draggedWidth=this.dragged.clientWidth,this.setStyles(this.dragged,{width:this.draggedWidth+"px",left:t.x-this.shiftX+"px",top:t.y-this.shiftY+"px"}),this.setStyles(this.placeholder,{height:this.draggedHeight+"px"}),this.insertPlaceholder(this.dragged),this.dragged.classList.add("sortable-list__item_dragging"),this.element.addEventListener("pointermove",this.onPointerMove)}dragend(){this.element.insertBefore(this.dragged,this.placeholder),this.placeholder.remove(),this.setStyles(this.dragged,{width:"",left:"",top:""}),this.dragged.classList.remove("sortable-list__item_dragging"),this.dragged=null,this.element.removeEventListener("pointermove",this.onPointerMove),this.element.removeEventListener("pointerup",this.onPointerUp),this.element.dispatchEvent(new CustomEvent("dragend"))}getMoveDirection(e,t){return e<t?"down":e>t?"up":void 0}insertPlaceholder(e){this.element.insertBefore(this.placeholder,e)}toHTML(e){const t=document.createElement("div");return t.innerHTML=e,t.firstElementChild}remove(){this.element&&this.element.remove(),this.element=null,this.removeEventListeners()}destroy(){this.remove()}}},12:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));class i{constructor(e="",{duration:t=1e3,type:s="success"}={}){this.message=e,this.duration=t,this.type=s,this.render()}get template(){return`\n      <div class="notification notification_${this.type} show">\n        <div class="notification__content"> ${this.message}</div>\n      </div>\n    `}setTimer(){setTimeout(()=>{this.destroy()},this.duration)}render(){const e=document.createElement("div");e.innerHTML=this.template,this.element=e.firstElementChild}show(e=document.body){i.currentNotification&&i.currentNotification.destroy(),e.append(this.element),clearTimeout(i.timer),i.timer=this.setTimer(),i.currentNotification=this}remove(){this.element&&this.element.remove(),this.element=null}destroy(){this.remove(),i.currentNotification=null}}},8:function(e,t,s){"use strict";s.r(t),s.d(t,"default",(function(){return a}));var i=s(11),n=s(12);function r(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class o{constructor(){r(this,"onClickOpen",e=>{e.target.closest(".category__header")&&e.target.closest(".category").classList.toggle("category_open")}),r(this,"onDragEnd",async e=>{const t=this.categories.find(t=>t.id===e);[...document.querySelector(`[data-id="${e}"]`).querySelectorAll(".categories__sortable-list-item")].forEach((e,s)=>{const i=e.dataset.id;t.subcategories.find(e=>e.id===i).weight=s+1}),await this.saveCategoryOrder(t.subcategories),this.notyShow("Позиции сохранены")}),this.url=new URL("api/rest/categories","https://course-js.javascript.ru/")}async render(){this.categories=await this.loadData();const e=this.toHTML("<div data-categories></div>");return e.append(...this.getCategoriesList(this.categories)),this.element=e,this.subElements=this.getSubElements(this.element),this.addEventListeners(),this.element}notyShow(e="",t="success",s=2e3){new n.a(e,{duration:s,type:t}).show()}getCategoriesList(e){const t=[];for(const s of e){const e=this.toHTML(this.getTemplate(s.title,s.id)),i=this.getSubcategoriesList(s.subcategories);e.querySelector(".subcategory-list").append(i),t.push(e),i.addEventListener("dragend",()=>this.onDragEnd(s.id))}return t}getSubcategoriesList(e){const t=e.map(e=>this.toHTML(this.getTemplateListItem(e.title,e.id,e.count)));return this.createSortableList(t)}getTemplate(e,t){return`\n        <div class="category category_open" data-id="${t}">\n            <header class="category__header">${e}</header>\n            <div class="category__body">\n                <div class="subcategory-list"></div>\n            </div>\n        </div>\n        `}getTemplateListItem(e,t,s){return`\n        <li class="categories__sortable-list-item sortable-list__item" data-grab-handle data-id="${t}">\n            <strong>${e}</strong>\n            <span><b>${s}</b> products</span>\n        </li>\n        `}async loadData(){this.url.searchParams.set("_sort","weight"),this.url.searchParams.set("_refs","subcategory");try{const e=await fetch(this.url.toString());return await e.json()}catch(e){console.error("Loading categories data error",e)}}createSortableList(e){return new i.a({items:e}).element}async saveCategoryOrder(e){const t=new URL("api/rest/subcategories","https://course-js.javascript.ru/"),s=await fetch(t,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});await s.json()}addEventListeners(){this.element.addEventListener("pointerup",this.onClickOpen)}getSubElements(e){const t={};return[...e.querySelectorAll("[data-element]")].forEach(e=>{t[e.dataset.element]=e}),t}remove(){this.element&&this.element.remove(),this.element=null}destroy(){this.remove(),this.removeEventListeners()}toHTML(e){const t=document.createElement("div");return t.innerHTML=e,t.firstElementChild}}class a{constructor(){var e,t,s;s=void 0,(t="conponents")in(e=this)?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s}async render(){return await this.initComponents(),this.element=this.toHTML(this.getTemplate()),this.renderComponents(),this.subElements=this.getSubElements(this.element),this.element}getTemplate(){return'\n        <div class="categories">\n            <div class="content__top-panel">\n            <h1 class="page-title">Категории товаров</h1>\n            </div>\n            <div data-element="categoriesContainer">\n                <div data-categories></div>\n            </div>\n        </div>\n    '}async initComponents(){const e=new o(this.productId);await e.render(),this.components={categories:e}}renderComponents(){for(const e of Object.entries(this.components))this.element.querySelector(`[data-${e[0]}]`).replaceWith(e[1].element)}getSubElements(e){const t={};return[...e.querySelectorAll("[data-element]")].forEach(e=>{t[e.dataset.element]=e}),t}remove(){this.element&&this.element.remove(),this.element=null}destroy(){this.remove(),this.removeEventListeners();for(const e of Object.values(this.components))e.destroy()}toHTML(e){const t=document.createElement("div");return t.innerHTML=e,t.firstElementChild}}}}]);
//# sourceMappingURL=categories-index-js-1.js.map